# Teams app CI/CD transparent guide
This document provide guidance on how to setup CI/CD pipeline for teams app created with the Teams Toolkit using your custom approach.

## Custom Deployment Approach
The most convenient way to deploy teams app to Azure is using [teamsapp CLI](https://learn.microsoft.com/en-us/microsoftteams/platform/toolkit/teams-toolkit-cli?pivots=version-three)'s `teamspp deploy` command. If you're unable to leverage the teamsapp CLI within your pipeline, you can create a custom deployment process tailored to your needs.

The `teamsapp deploy` command executes the actions in teamsapp.yml's "deploy" stage and this stage contains 2 parts: build and deploy. What you need to do is rewritting these actions into your own way.

Taking basic bot typescript project as an example, its teamsapp.yml's deploy stage is as following:
```yml
deploy:
  # Run npm command
  - uses: cli/runNpmCommand
    name: install dependencies
    with:
      args: install
  - uses: cli/runNpmCommand
    name: build app
    with:
      args: run build --if-present
  # Deploy your application to Azure App Service using the zip deploy feature.
  # For additional details, refer to https://aka.ms/zip-deploy-to-app-services.
  - uses: azureAppService/zipDeploy
    with:
      # Deploy base folder
      artifactFolder: .
      # Ignore file location, leave blank will ignore nothing
      ignoreFile: .webappignore
      # The resource id of the cloud resource to be deployed to.
      # This key will be generated by arm/deploy action automatically.
      # You can replace it with your existing Azure Resource id
      # or add it to your environment variable file.
      resourceId: ${{BOT_AZURE_APP_SERVICE_RESOURCE_ID}}
```
These actions do the following things:
- run `npm install` and `npm build` to build the project.
- deploy code to Azure app service.

You can rewrite these actions in your CI/CD pipeline in your own way. 
Below is an example of using GitHub official actions:
```yml
    # build
    - name: Setup Node 18.x
      uses: actions/setup-node@v1
      with:
        node-version: '18.x'
    - name: 'npm install, build'
      run: |
        npm install
        npm run build --if-present

    - name: 'zip artifact for deployment'
      run: |
        zip -r deploy.zip . --include 'node_modules/*' 'lib/*' 'web.config'

    # deploy
    - name: 'Login via Azure CLI'
      uses: azure/login@v1
      with:
        client-id: ${{ vars.CLIENT_ID }}
        tenant-id: ${{ vars.TENANT_ID }}
        subscription-id: ${{ vars.SUBSCRIPTION_ID }}

    - name: 'Run Azure webapp deploy action using azure RBAC'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ vars.AZURE_WEBAPP_NAME }}
        package: deploy.zip
```

Currently, the Teams Toolkit supports Teams app projects written in different programming languages and suitable to be hosted on different Azure services. You can refer to below official actions when setting up CI/CD deployment pipelines for these projects.

Build:

| language      | GitHub                    |Azure Pipeline
|---------------------------------------------------|-------------------------------|----|
| JS/TS                | [actions/setup-node](https://github.com/actions/setup-node)  |[NodeTool@0](https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/node-tool-v0?view=azure-pipelines) | 
| C#      | [actions/setup-dotnet](https://github.com/actions/setup-dotnet)  |[DotNetCoreCLI@2](https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/dotnet-core-cli-v2?view=azure-pipelines)|


Deploy:

| resource   | GitHub                  |Azure Pipeline
|---------------------------------------------------|-------------------------------|----|
| App Service               |[azure/webapps-deploy](https://github.com/Azure/webapps-deploy)| [AzureWebApp@1](https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-web-app-v1?view=azure-pipelines)
| Function          |[Azure/functions-action](https://github.com/Azure/functions-action)|[AzureFunctionApp@2](https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-function-app-v2?view=azure-pipelines)
| Static Web App             |[Azure/static-web-apps-deploy](https://github.com/Azure/static-web-apps-deploy)| [AzureStaticWebApp@0](https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-static-web-app-v0?view=azure-pipelines)|
## Credential needed for deployment
If you are using CI/CD to deploy app code to Azure app service, Azure functions or Azure container app, you need a service principal configured with minimum required access to the resource. There are 2 ways of login to Azure using service principal: using OpenID Connect(OIDC) or secret.

### OIDC (recommended)
OIDC is the recommended way since it has increased security. To use it in GitHub actions, follow this [guide](https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Cwindows#create-a-microsoft-entra-application-and-service-principal) to create the service principal and add federated credentials, and set the client id , tenant id and sub id in GitHub repo, then you can use Azure/login action like following:
```yml
- name: 'Login using OIDC'
      uses: azure/login@v1
      with:
        client-id: ${{ vars.SERVICE_PRINCIPAL_CLIENT_ID }}
        tenant-id: ${{ vars.SERVICE_PRINCIPAL_TENANT_ID }}
        subscription-id: ${{ vars.SERVICE_PRINCIPAL_SUBSCRIPTION_ID }}
```
> To use OIDC in GitHub actions, you need to modify the permission in CI/CD:
```yml
permissions: 
  id-token: write
  contents: read
```

  For Azure pipeline, follow this [guide](https://learn.microsoft.com/en-us/azure/devops/pipelines/library/connect-to-azure?view=azure-devops#create-an-azure-resource-manager-service-connection-using-workload-identity-federation) to create a workload identity federation service connection. Then you can use the connection name in your pipeline:

```yml
- task: AzureWebApp@1
  inputs:
    azureSubscription: $(connection_name)
    appName: $(app_name)
    package: '$(System.DefaultWorkingDirectory)/'
  displayName: 'Deploy to Azure Web App'
```

### Secret
For Github actions, follow this [guide](https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Cwindows#use-the-azure-login-action-with-a-service-principal-secret) to create a service principal and secret. Then you can use Azure/login action like:
```yml
    - uses: Azure/login@v1
      with:
        creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'
```
For Azure pipeline, follow this [guide](https://learn.microsoft.com/en-us/azure/devops/pipelines/library/connect-to-azure?view=azure-devops#create-an-azure-resource-manager-service-connection-using-a-service-principal-secret) to create a service principal service connection. Then you can use the service connection name in actions like below:
```yml
    - task: AzureWebApp@1
      inputs:
        azureSubscription: $(connection_name)
        appName: $(app_name)
        package: '$(System.DefaultWorkingDirectory)/'
      displayName: 'Deploy to Azure Web App'
```
## Test the teams app
You will need the `appPackage` to test your Teams app. Teamsapp CLI's command "teamsapp package" can help you create the `appPackage.zip` automatically. If you cannot leverage teamsapp CLI to do this, you can follow below steps to create the appPackage by hand.

1. prepare `mainfest.json`.

    The default `manifest.json` in Teams Toolkit project has placeholders (wrapped in ${{}}). You should replace these placeholders with true values.

2. prepare App icons.

    Your should prepare 2 .png versions of your app icon: a color and outline version. You can check [here](https://learn.microsoft.com/en-us/microsoftteams/platform/concepts/build-and-test/apps-package#app-icons) for the details of the app icon.

3. zip the appPackage.

    Zip the above manifest.json and 2 .png files into `appPackage.zip`.

You can pass this `appPackage.zip` to testers/developers to test the Teams app. They can follow these [steps](https://learn.microsoft.com/en-us/microsoftteams/platform/concepts/deploy-and-publish/apps-upload) to upload the Teams app.